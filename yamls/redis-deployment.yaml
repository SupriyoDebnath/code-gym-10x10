apiVersion: v1
kind: Secret
metadata:
 name: redis-secret
type: Opaque
data:
 REDIS_PASSWORD: VlRoeEF6N1dNOURxMi5S

---
apiVersion: v1
kind: PersistentVolume
metadata:
 name: redis-pv
spec:
 capacity:
  storage: 5Gi
 accessModes:
  - ReadWriteOnce
 hostPath:
  path: /data/redis
  type: DirectoryOrCreate

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
 name: redis-pvc
spec:
 accessModes:
  - ReadWriteOnce
 resources:
  requests:
   storage: 5Gi
 storageClassName: ""

---
apiVersion: apps/v1
kind: Deployment
metadata:
 name: redis
spec:
 replicas: 1
 selector:
  matchLabels:
   app: redis
 template:
  metadata:
   labels:
    app: redis
  spec:
   containers:
   - name: redis
     image: redis:7
     ports:
     - containerPort: 6379
     env:
     - name: REDIS_PASSWORD
       valueFrom:
        secretKeyRef:
         name: redis-secret
         key: REDIS_PASSWORD
     command: ["redis-server"]
     args: ["--requirepass", "$(REDIS_PASSWORD)"]
     volumeMounts:
     - name: redis-storage
       mountPath: /data
     resources:
      requests:
       memory: "512Mi"
       cpu: "250m"
      limits:
       memory: "2Gi"
       cpu: "1000m"
   volumes:
   - name: redis-storage
     persistentVolumeClaim:
      claimName: redis-pvc

---
apiVersion: v1
kind: Service
metadata:
 name: redis-service
spec:
 type: NodePort
 ports:
  - port: 6379
    targetPort: 6379
    nodePort: 30020
 selector:
  app: redis